syntax = "proto3";

package ingester.v1;

option go_package = "tradr-backfiller-relay/proto;proto";

// IngesterService handles streaming operations from the backfiller relay
// This provides filtered, pre-processed operations rather than raw commits
service IngesterService {
  // StreamOperations creates a bidirectional stream for continuous operation processing
  // The relay sends individual operations, the ingester responds with acknowledgments
  rpc StreamOperations(stream OperationRequest) returns (stream OperationResponse);
  
  // HealthCheck verifies the ingester is running and ready to accept operations
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

// OperationRequest represents a single operation (create/update/delete)
// This is more granular than commits and allows for filtering
message OperationRequest {
  // DID of the repository
  string repo = 1;
  
  // Collection name (e.g., "app.bsky.feed.post")
  string collection = 2;
  
  // Record key
  string rkey = 3;
  
  // Operation-specific data
  oneof operation {
    CreateOperation create = 4;
    UpdateOperation update = 5;
    DeleteOperation delete = 6;
  }
  
  // Sequence number from firehose
  int64 seq = 7;
  
  // ISO 8601 timestamp
  string time = 8;
  
  // Revision of the repo at this operation
  string rev = 9;
}

// CreateOperation for new records
message CreateOperation {
  // The actual record data (CBOR encoded)
  bytes record = 1;
  
  // CID of the record
  string cid = 2;
}

// UpdateOperation for modified records
message UpdateOperation {
  // The updated record data (CBOR encoded)
  bytes record = 1;
  
  // New CID of the record
  string cid = 2;
  
  // Previous CID (for verification)
  optional string prev_cid = 3;
}

// DeleteOperation for removed records
message DeleteOperation {
  // Previous CID of the deleted record
  optional string prev_cid = 1;
}

// OperationResponse acknowledges processing of an operation
message OperationResponse {
  // Whether the operation was successfully processed
  bool success = 1;
  
  // Error message if processing failed
  string error = 2;
  
  // Sequence number to acknowledge
  int64 seq = 3;
}

// CommitRequest represents a commit from the firehose or backfill
// This matches the structure of com.atproto.sync.subscribeRepos#commit
// (Keeping this for potential future use but not used in current service)
message CommitRequest {
  // DID of the repository this commit belongs to
  string repo = 1;
  
  // Revision string from the commit
  string rev = 2;
  
  // Previous revision (null for first commit)
  optional string since = 3;
  
  // The operations in this commit
  repeated RepoOp ops = 4;
  
  // CAR file blocks containing the actual record data
  bytes blocks = 5;
  
  // Sequence number from firehose for ordering
  int64 seq = 6;
  
  // ISO 8601 timestamp when this commit was created
  string time = 7;
  
  // Indicates if this commit was too big to include ops (requires separate fetch)
  bool too_big = 8;
  
  // Previous data CID for verification (optional)
  optional string prev_data = 9;
  
  // Commit CID
  string commit = 10;
  
  // Blob references in this commit
  repeated string blobs = 11;
}

// RepoOp represents a single operation within a commit
// This matches com.atproto.sync.subscribeRepos#repoOp
message RepoOp {
  // Action type: "create", "update", or "delete"
  string action = 1;
  
  // Record path (e.g., "app.bsky.feed.post/3k2yihcrp6f2c")
  string path = 2;
  
  // CID of the record (null for deletes)
  optional string cid = 3;
  
  // Previous CID (for updates and deletes)
  optional string prev = 4;
}

// CommitResponse contains the result of processing a commit
message CommitResponse {
  // Whether the commit was successfully processed
  bool success = 1;
  
  // Error message if the commit failed
  string error = 2;
  
  // Sequence number to acknowledge specific commit
  int64 seq = 3;
  
  // Processing timestamp for metrics
  string processed_at = 4;
}

// HealthCheckRequest for checking ingester status
message HealthCheckRequest {}

// HealthCheckResponse indicates the health status of the ingester
message HealthCheckResponse {
  // Whether the ingester is healthy and ready
  bool healthy = 1;
  
  // Human-readable status message
  string status = 2;
  
  // Current backlog size (if applicable)
  int64 backlog = 3;
}

// Additional event types that might come through the firehose
// These are less common but included for completeness

// IdentityEvent represents a change to an account's identity
message IdentityEvent {
  string did = 1;
  optional string handle = 2;
  int64 seq = 3;
  string time = 4;
}

// AccountEvent represents a change to account status
message AccountEvent {
  string did = 1;
  bool active = 2;
  optional string status = 3;
  int64 seq = 4;
  string time = 5;
}

// HandleEvent represents a handle change
message HandleEvent {
  string did = 1;
  string handle = 2;
  int64 seq = 3;
  string time = 4;
}

// TombstoneEvent represents repo deletion
message TombstoneEvent {
  string did = 1;
  int64 seq = 2;
  string time = 3;
}

// MigrateEvent represents repo migration
message MigrateEvent {
  string did = 1;
  string migrate_to = 2;
  int64 seq = 3;
  string time = 4;
}

// InfoEvent represents informational messages from the relay
message InfoEvent {
  string name = 1;
  optional string message = 2;
}

// EventWrapper for different event types if we want to support all firehose events
message FirehoseEvent {
  oneof event {
    CommitRequest commit = 1;
    IdentityEvent identity = 2;
    AccountEvent account = 3;
    HandleEvent handle = 4;
    TombstoneEvent tombstone = 5;
    MigrateEvent migrate = 6;
    InfoEvent info = 7;
  }
}