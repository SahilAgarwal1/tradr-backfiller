backfill_jobs:
  query: |
    SELECT 
      state,
      COUNT(*) as count
    FROM gorm_db_jobs
    GROUP BY state
  metrics:
    - state:
        usage: "LABEL"
        description: "State of the backfill job (enqueued, in_progress, complete, failed)"
    - count:
        usage: "GAUGE"
        description: "Number of jobs in this state"

backfill_queue_size:
  query: |
    SELECT 
      COUNT(*) as queued_jobs
    FROM gorm_db_jobs
    WHERE state = 'enqueued'
  metrics:
    - queued_jobs:
        usage: "GAUGE"
        description: "Number of backfill jobs waiting to be processed"

backfill_processing_rate:
  query: |
    SELECT 
      COUNT(*) as completed_last_hour
    FROM gorm_db_jobs
    WHERE state = 'complete'
      AND updated_at > NOW() - INTERVAL '1 hour'
  metrics:
    - completed_last_hour:
        usage: "GAUGE"
        description: "Number of backfill jobs completed in the last hour"

backfill_avg_duration:
  query: |
    SELECT 
      EXTRACT(EPOCH FROM AVG(updated_at - created_at)) as avg_duration_seconds
    FROM gorm_db_jobs
    WHERE state = 'complete'
      AND updated_at > NOW() - INTERVAL '1 hour'
  metrics:
    - avg_duration_seconds:
        usage: "GAUGE"
        description: "Average duration of completed backfill jobs in seconds"

cursor_position:
  query: |
    SELECT 
      seq as cursor_position
    FROM last_seqs
    WHERE id = 1
  metrics:
    - cursor_position:
        usage: "GAUGE"
        description: "Current firehose cursor position"

backfill_oldest_queued:
  query: |
    SELECT 
      COALESCE(EXTRACT(EPOCH FROM (NOW() - MIN(created_at))), 0) as oldest_queued_age_seconds
    FROM gorm_db_jobs
    WHERE state = 'enqueued'
  metrics:
    - oldest_queued_age_seconds:
        usage: "GAUGE"
        description: "Age of the oldest queued job in seconds"