# Custom queries for PostgreSQL exporter to expose backfill metrics

relay_backfill_jobs_active:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'in_progress'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs currently being processed"

relay_backfill_jobs_pending:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'enqueued'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs waiting to be processed"

relay_backfill_jobs_failed:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state LIKE 'failed%'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs that have failed"

relay_backfill_jobs_completed:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'complete'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs completed"

relay_backfill_completed_total:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'complete'"
  metrics:
    - value:
        usage: "COUNTER"
        description: "Total repos completed (use with rate() for repos/sec)"

relay_backfill_completed_recent:
  query: |
    SELECT 
      COUNT(*) as value
    FROM gorm_db_jobs 
    WHERE state = 'complete' 
      AND updated_at > NOW() - INTERVAL '5 minutes'
  metrics:
    - value:
        usage: "GAUGE"
        description: "Repos completed in last 5 minutes"

relay_backfill_active_jobs:
  query: |
    SELECT 
      repo,
      state,
      rev,
      retry_count,
      EXTRACT(EPOCH FROM (NOW() - updated_at)) as seconds_since_update
    FROM gorm_db_jobs 
    WHERE state = 'in_progress'
    ORDER BY updated_at DESC
    LIMIT 20
  metrics:
    - repo:
        usage: "LABEL"
        description: "Repository DID"
    - state:
        usage: "LABEL"
        description: "Job state"
    - rev:
        usage: "LABEL"
        description: "Current revision"
    - retry_count:
        usage: "GAUGE"
        description: "Number of retries"
    - seconds_since_update:
        usage: "GAUGE"
        description: "Seconds since last update"