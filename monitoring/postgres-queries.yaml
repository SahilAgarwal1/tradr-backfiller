# Custom queries for PostgreSQL exporter to expose backfill metrics
# These metrics are queried directly from the database, so they persist across restarts

relay_backfill_jobs_total:
  query: "SELECT COUNT(*) as total_jobs FROM gorm_db_jobs"
  metrics:
    - total_jobs:
        usage: "GAUGE"
        description: "Total number of jobs in the database"

relay_backfill_jobs_active:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'in_progress'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs currently being processed"

relay_backfill_jobs_pending:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'enqueued'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs waiting to be processed"

relay_backfill_jobs_failed:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state LIKE 'failed%'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs that have failed"

relay_backfill_jobs_completed:
  query: "SELECT COUNT(*) as value FROM gorm_db_jobs WHERE state = 'complete'"
  metrics:
    - value:
        usage: "GAUGE"
        description: "Number of backfill jobs completed"

relay_backfill_jobs_total_by_state:
  query: |
    SELECT 
      state,
      COUNT(*) as value
    FROM gorm_db_jobs
    GROUP BY state
  metrics:
    - state:
        usage: "LABEL"
        description: "Job state"
    - value:
        usage: "GAUGE"
        description: "Number of jobs in this state"

relay_backfill_throughput_1m:
  query: |
    SELECT 
      COUNT(*) as repos_per_minute
    FROM gorm_db_jobs 
    WHERE state = 'complete' 
      AND updated_at > NOW() - INTERVAL '1 minute'
  metrics:
    - repos_per_minute:
        usage: "GAUGE"
        description: "Repos completed in last minute"

relay_backfill_throughput_5m:
  query: |
    SELECT 
      COUNT(*) / 5.0 as repos_per_minute
    FROM gorm_db_jobs 
    WHERE state = 'complete' 
      AND updated_at > NOW() - INTERVAL '5 minutes'
  metrics:
    - repos_per_minute:
        usage: "GAUGE"
        description: "Average repos per minute over last 5 minutes"

relay_backfill_active_jobs:
  query: |
    SELECT 
      repo,
      state,
      rev,
      retry_count,
      EXTRACT(EPOCH FROM (NOW() - updated_at)) as seconds_since_update
    FROM gorm_db_jobs 
    WHERE state = 'in_progress'
    ORDER BY updated_at DESC
    LIMIT 20
  metrics:
    - repo:
        usage: "LABEL"
        description: "Repository DID"
    - state:
        usage: "LABEL"
        description: "Job state"
    - rev:
        usage: "LABEL"
        description: "Current revision"
    - retry_count:
        usage: "GAUGE"
        description: "Number of retries"
    - seconds_since_update:
        usage: "GAUGE"
        description: "Seconds since last update"